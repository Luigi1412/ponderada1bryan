<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2"><%= title %></h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <div class="btn-group me-2">
      <a href="/enderecos/novo" class="btn btn-sm btn-outline-secondary">Novo Endereço</a>
    </div>
  </div>
</div>
<p><%= description %></p>

<div class="table-responsive">
  <table class="table table-striped table-sm">
    <thead>
      <tr>
        <th scope="col">ID</th>
        <th scope="col">Usuário</th>
        <th scope="col">Rua</th>
        <th scope="col">Número</th>
        <th scope="col">Cidade</th>
        <th scope="col">Estado</th>
        <th scope="col">CEP</th>
        <th scope="col">Ações</th>
      </tr>
    </thead>
    <tbody>
      <% if (locals.enderecos && enderecos.length > 0) { %>
        <% enderecos.forEach(endereco => { %>
          <tr id="endereco-<%= endereco.id %>">
            <td><%= endereco.id %></td>
            <td><%= endereco.usuario_nome || 'N/A' %></td>
            <td><%= endereco.rua %></td>
            <td><%= endereco.numero %></td>
            <td><%= endereco.cidade %></td>
            <td><%= endereco.estado %></td>
            <td><%= endereco.cep %></td>
            <td>
              <a href="/enderecos/editar/<%= endereco.id %>" class="btn btn-sm btn-primary">Editar</a>
              <button onclick="deleteItem('<%= endereco.id %>', 'enderecos')" class="btn btn-sm btn-danger">Excluir</button>
            </td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr>
          <td colspan="8" class="text-center">Nenhum endereço encontrado.</td>
        </tr>
      <% } %>
    </tbody>
  </table>
</div>

<script>
async function carregarEnderecos() {
  const res = await fetch('/enderecos/api');
  const enderecos = await res.json();
  const lista = document.getElementById('lista-enderecos');
  lista.innerHTML = '';
  enderecos.forEach(endereco => {
    const li = document.createElement('li');
    li.className = "flex justify-between items-center bg-gray-100 rounded px-4 py-2";
    li.innerHTML = `
      <span class="text-gray-700">${endereco.rua}, ${endereco.numero} - ${endereco.cidade}/${endereco.estado} (Usuário: ${endereco.usuario_id})</span>
      <button class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition" onclick="deletarEndereco(${endereco.id})">
        <i class="fas fa-trash"></i> Excluir
      </button>
    `;
    lista.appendChild(li);
  });
}

async function criarEndereco() {
  const rua = document.getElementById('nova-rua').value;
  const numero = document.getElementById('novo-numero').value;
  const cidade = document.getElementById('nova-cidade').value;
  const estado = document.getElementById('novo-estado').value;
  const usuario_id = document.getElementById('novo-usuario').value;
  if (!rua || !numero || !cidade || !estado || !usuario_id) {
    showToast('Preencha todos os campos', 'error');
    return;
  }
  const btn = document.querySelector('button[onclick="criarEndereco()"]');
  btn.disabled = true;
  await fetch('/enderecos/api', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ rua, numero, cidade, estado, usuario_id })
  });
  btn.disabled = false;
  document.getElementById('nova-rua').value = '';
  document.getElementById('novo-numero').value = '';
  document.getElementById('nova-cidade').value = '';
  document.getElementById('novo-estado').value = '';
  document.getElementById('novo-usuario').value = '';
  showToast('Endereço criado com sucesso!');
  carregarEnderecos();
}

async function deletarEndereco(id) {
  await fetch('/enderecos/api/' + id, { method: 'DELETE' });
  showToast('Endereço excluído com sucesso!');
  carregarEnderecos();
}

window.onload = carregarEnderecos;
</script>